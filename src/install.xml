<?xml version="1.0" encoding="utf-8"?>
<!--
This file is part of "Playful Sparkle - Google reCAPTCHA" project and subject to the terms
and conditions defined in file "LICENSE", which is part of this source
code package and also available on the project page: https://github.com/playfulsparkle/oc3_google_recaptcha.git
-->
<modification>
    <name>Playful Sparkle - Google reCAPTCHA</name>
    <code>ps_google_recaptcha</code>
    <version>1.0.0</version>
    <author>Playful Sparkle</author>
    <link>https://github.com/playfulsparkle/oc3_google_recaptcha.git</link>
    <file path="catalog/view/theme/default/template/common/header.twig">
        <operation>
            <search><![CDATA[</head>]]></search>
            <add position="before"><![CDATA[<link rel="preconnect" href="https://www.google.com">
            <link rel="preconnect" href="https://www.gstatic.com" crossorigin>]]></add>
        </operation>
    </file>
    <file path="admin/controller/setting/setting.php">
        <operation>
            <search><![CDATA[$data['captcha_pages'] = array();]]></search>
            <add position="after"><![CDATA[
            $this->load->language('extension/captcha/ps_google_recaptcha', 'ps_google_recaptcha');

            $ps_language = $this->language->get('ps_google_recaptcha');

            $data['captcha_pages'][] = array(
                'text' => $ps_language->get('text_login'),
                'value' => 'login'
            );
            ]]></add>
        </operation>
    </file>
    <!-- register start -->
    <file path="catalog/controller/account/register.php">
        <operation>
            <search><![CDATA[$this->response->setOutput($this->load->view('account/register', $data));]]></search>
            <add position="before"><![CDATA[
            if (
                $this->config->get('captcha_ps_google_recaptcha_status') &&
                ($this->config->get('captcha_ps_google_recaptcha_key_type') !== 'v3' ||
                $this->config->get('captcha_ps_google_recaptcha_key_type') !== 'v2_invisible')
            ) {
                if (!isset($this->session->data['ps_google_recaptcha_counter'])) {
                    $this->session->data['ps_google_recaptcha_counter'] = 0;
                } else {
                    $this->session->data['ps_google_recaptcha_counter']++;
                }

                $data['ps_widget_counter'] = $this->session->data['ps_google_recaptcha_counter'];
                $data['ps_key_type'] = $this->config->get('captcha_ps_google_recaptcha_key_type');
                $data['ps_badge_theme'] = $this->config->get('captcha_ps_google_recaptcha_badge_theme');
                $data['ps_badge_size'] = $this->config->get('captcha_ps_google_recaptcha_badge_size');
                $data['ps_badge_position'] = $this->config->get('captcha_ps_google_recaptcha_badge_position');
                $data['ps_site_key'] = $this->config->get('captcha_ps_google_recaptcha_site_key');
            }
            ]]></add>
        </operation>
    </file>
    <file path="catalog/view/theme/default/template/account/register.twig">
        <operation>
            <search position="replace"><![CDATA[<input type="submit" value="{{ button_continue }}" class="btn btn-primary" />]]></search>
            <add><![CDATA[
            {% if ps_key_type == 'v3' or ps_key_type == 'v2_invisible' %}
                <script src="https://www.google.com/recaptcha/api.js?render={{ ps_site_key }}{% if ps_badge_position != 'inline' %}&badge={{ ps_badge_position }}{% endif %}" async defer></script>
                <script>
                    var form = document.currentScript ? document.currentScript.closest('form') : null;

                    function onFormSubmit{{ ps_widget_counter }}(token) {
                        if (form) {
                            var submitEvent = new Event('submit', { bubbles: true, cancelable: true });

                            if (form.dispatchEvent(submitEvent)) {
                                form.submit();
                            }
                        } else {
                            console.error("No form element found for the current script.");
                        }
                    }
                </script>
                <input type="submit" value="{{ button_continue }}" class="btn btn-primary g-recaptcha" data-sitekey="{{ ps_site_key }}" data-theme="{{ ps_badge_theme }}" data-callback="onFormSubmit{{ ps_widget_counter }}" data-badge="{{ ps_badge_position }}"{% if ps_key_type == 'v2_invisible' %} data-size="{{ ps_badge_size }}"{% endif %} data-action="submit" />
            {% else %}
                <input type="submit" value="{{ button_continue }}" class="btn btn-primary" />
            {% endif %}
            ]]></add>
        </operation>
    </file>
    <!-- register end -->
    <!-- return start -->
    <file path="catalog/controller/account/return.php">
        <operation>
            <search><![CDATA[$this->response->setOutput($this->load->view('account/return_form', $data));]]></search>
            <add position="before"><![CDATA[
            if (
                $this->config->get('captcha_ps_google_recaptcha_status') &&
                ($this->config->get('captcha_ps_google_recaptcha_key_type') !== 'v3' ||
                $this->config->get('captcha_ps_google_recaptcha_key_type') !== 'v2_invisible')
            ) {
                if (!isset($this->session->data['ps_google_recaptcha_counter'])) {
                    $this->session->data['ps_google_recaptcha_counter'] = 0;
                } else {
                    $this->session->data['ps_google_recaptcha_counter']++;
                }

                $data['ps_widget_counter'] = $this->session->data['ps_google_recaptcha_counter'];
                $data['ps_key_type'] = $this->config->get('captcha_ps_google_recaptcha_key_type');
                $data['ps_badge_theme'] = $this->config->get('captcha_ps_google_recaptcha_badge_theme');
                $data['ps_badge_size'] = $this->config->get('captcha_ps_google_recaptcha_badge_size');
                $data['ps_badge_position'] = $this->config->get('captcha_ps_google_recaptcha_badge_position');
                $data['ps_site_key'] = $this->config->get('captcha_ps_google_recaptcha_site_key');
            }
            ]]></add>
        </operation>
    </file>
    <file path="catalog/view/theme/default/template/account/return_form.twig">
        <operation>
            <search position="replace"><![CDATA[<input type="submit" value="{{ button_submit }}" class="btn btn-primary" />]]></search>
            <add><![CDATA[
            {% if ps_key_type == 'v3' or ps_key_type == 'v2_invisible' %}
                <script src="https://www.google.com/recaptcha/api.js?render={{ ps_site_key }}{% if ps_badge_position != 'inline' %}&badge={{ ps_badge_position }}{% endif %}" async defer></script>
                <script>
                    var form = document.currentScript ? document.currentScript.closest('form') : null;

                    function onFormSubmit{{ ps_widget_counter }}(token) {
                        if (form) {
                            var submitEvent = new Event('submit', { bubbles: true, cancelable: true });

                            if (form.dispatchEvent(submitEvent)) {
                                form.submit();
                            }
                        } else {
                            console.error("No form element found for the current script.");
                        }
                    }
                </script>
                <input type="submit" value="{{ button_submit }}" class="btn btn-primary g-recaptcha" data-sitekey="{{ ps_site_key }}" data-theme="{{ ps_badge_theme }}" data-callback="onFormSubmit{{ ps_widget_counter }}" data-badge="{{ ps_badge_position }}"{% if ps_key_type == 'v2_invisible' %} data-size="{{ ps_badge_size }}"{% endif %} data-action="submit" />
            {% else %}
                <input type="submit" value="{{ button_submit }}" class="btn btn-primary" />
            {% endif %}
            ]]></add>
        </operation>
    </file>
    <!-- return end -->
    <!-- contact start -->
    <file path="catalog/controller/information/contact.php">
        <operation>
            <search><![CDATA[$this->response->setOutput($this->load->view('information/contact', $data));]]></search>
            <add position="before"><![CDATA[
            if (
                $this->config->get('captcha_ps_google_recaptcha_status') &&
                ($this->config->get('captcha_ps_google_recaptcha_key_type') !== 'v3' ||
                $this->config->get('captcha_ps_google_recaptcha_key_type') !== 'v2_invisible')
            ) {
                if (!isset($this->session->data['ps_google_recaptcha_counter'])) {
                    $this->session->data['ps_google_recaptcha_counter'] = 0;
                } else {
                    $this->session->data['ps_google_recaptcha_counter']++;
                }

                $data['ps_widget_counter'] = $this->session->data['ps_google_recaptcha_counter'];
                $data['ps_key_type'] = $this->config->get('captcha_ps_google_recaptcha_key_type');
                $data['ps_badge_theme'] = $this->config->get('captcha_ps_google_recaptcha_badge_theme');
                $data['ps_badge_size'] = $this->config->get('captcha_ps_google_recaptcha_badge_size');
                $data['ps_badge_position'] = $this->config->get('captcha_ps_google_recaptcha_badge_position');
                $data['ps_site_key'] = $this->config->get('captcha_ps_google_recaptcha_site_key');
            }
            ]]></add>
        </operation>
    </file>
    <file path="catalog/view/theme/default/template/information/contact.twig">
        <operation>
            <search position="replace"><![CDATA[<input class="btn btn-primary" type="submit" value="{{ button_submit }}" />]]></search>
            <add><![CDATA[
            {% if ps_key_type == 'v3' or ps_key_type == 'v2_invisible' %}
                <script src="https://www.google.com/recaptcha/api.js?render={{ ps_site_key }}{% if ps_badge_position != 'inline' %}&badge={{ ps_badge_position }}{% endif %}" async defer></script>
                <script>
                    var form = document.currentScript ? document.currentScript.closest('form') : null;

                    function onFormSubmit{{ ps_widget_counter }}(token) {
                        if (form) {
                            var submitEvent = new Event('submit', { bubbles: true, cancelable: true });

                            if (form.dispatchEvent(submitEvent)) {
                                form.submit();
                            }
                        } else {
                            console.error("No form element found for the current script.");
                        }
                    }
                </script>
                <input class="btn btn-primary g-recaptcha" data-sitekey="{{ ps_site_key }}" data-theme="{{ ps_badge_theme }}" data-callback="onFormSubmit{{ ps_widget_counter }}" data-badge="{{ ps_badge_position }}"{% if ps_key_type == 'v2_invisible' %} data-size="{{ ps_badge_size }}"{% endif %} data-action="submit" type="submit" value="{{ button_submit }}" />
            {% else %}
                <input class="btn btn-primary" type="submit" value="{{ button_submit }}" />
            {% endif %}
            ]]></add>
        </operation>
    </file>
    <!-- contact end -->
    <!-- login start -->
    <file path="catalog/controller/account/login.php">
        <operation>
            <search><![CDATA[protected function validate() {]]></search>
            <add position="after"><![CDATA[
            if ($this->config->get('captcha_ps_google_recaptcha_status')) {
                $this->load->language('extension/captcha/ps_google_recaptcha', 'ps_google_recaptcha');

                $ps_language = $this->language->get('ps_google_recaptcha');

                unset($this->session->data['ps_google_recaptcha_counter']);

                if (isset($this->request->post['g-recaptcha-response'])) {
                    $recaptcha = file_get_contents('https://www.google.com/recaptcha/api/siteverify?secret=' . urlencode($this->config->get('captcha_ps_google_recaptcha_secret_key')) . '&response=' . $this->request->post['g-recaptcha-response'] . '&remoteip=' . $this->request->server['REMOTE_ADDR']);

                    $recaptcha = (array) json_decode($recaptcha, true);

                    if ($recaptcha) {
                        if (!$recaptcha['success']) {
                            if (isset($recaptcha['error-codes'])) {
                                $errors = array();

                                foreach ($recaptcha['error-codes'] as $error_code) {
                                    $errors[] = $ps_language->get('error_' . str_replace('-', '_', $error_code));
                                }

                                $this->error['captcha'] = implode(', ', $errors);
                            } else {
                                $this->error['captcha'] = $ps_language->get('error_captcha');
                            }
                        }
                    } else {
                        $this->error['captcha'] = $ps_language->get('error_captcha');
                    }
                } else {
                    $this->error['captcha'] = $ps_language->get('error_captcha');
                }
            }
            ]]></add>
        </operation>
    </file>
    <file path="catalog/controller/account/login.php">
        <operation>
            <search><![CDATA[$this->response->setOutput($this->load->view('account/login', $data));]]></search>
            <add position="before"><![CDATA[
            if (
                in_array('login', (array)$this->config->get('config_captcha_page')) &&
                $this->config->get('captcha_ps_google_recaptcha_status') &&
                ($this->config->get('captcha_ps_google_recaptcha_key_type') !== 'v3' ||
                $this->config->get('captcha_ps_google_recaptcha_key_type') !== 'v2_invisible')
            ) {
                $this->load->language('extension/captcha/ps_google_recaptcha', 'ps_google_recaptcha');

                $ps_language = $this->language->get('ps_google_recaptcha');

                $data['ps_entry_score_based_captcha'] = $ps_language->get('entry_score_based_captcha');

                if (isset($this->error['captcha'])) {
                    $data['ps_error_captcha'] = $this->error['captcha'];
                } else {
                    $data['ps_error_captcha'] = '';
                }

                if (!isset($this->session->data['ps_google_recaptcha_counter'])) {
                    $this->session->data['ps_google_recaptcha_counter'] = 0;
                } else {
                    $this->session->data['ps_google_recaptcha_counter']++;
                }

                $data['ps_widget_counter'] = $this->session->data['ps_google_recaptcha_counter'];
                $data['ps_key_type'] = $this->config->get('captcha_ps_google_recaptcha_key_type');
                $data['ps_badge_theme'] = $this->config->get('captcha_ps_google_recaptcha_badge_theme');
                $data['ps_badge_size'] = $this->config->get('captcha_ps_google_recaptcha_badge_size');
                $data['ps_badge_position'] = $this->config->get('captcha_ps_google_recaptcha_badge_position');
                $data['ps_site_key'] = $this->config->get('captcha_ps_google_recaptcha_site_key');
            }
            ]]></add>
        </operation>
    </file>
    <file path="catalog/view/theme/default/template/account/login.twig">
        <operation>
            <search><![CDATA[<input type="submit" value="{{ button_login }}" class="btn btn-primary" />]]></search>
            <add position="before"><![CDATA[
            {% if ps_key_type == 'v3' or ps_key_type == 'v2_invisible' %}
            <div class="form-group">
                <label class="control-label" for="input-google-recaptcha">{{ ps_entry_score_based_captcha }}</label>
                {% if error_captcha %}<div class="text-danger">{{ error_captcha }}</div>{% endif %}
            </div>
            {% elseif ps_key_type == 'v2_checkbox' %}
            <div class="form-group">
                <label class="control-label" for="input-google-recaptcha">{{ ps_entry_score_based_captcha }}</label>
                <div id="g-recaptcha-{{ ps_widget_counter }}" data-sitekey="{{ ps_site_key }}"></div>
                <script type="text/javascript">
                    var recaptcha_widget{{ ps_widget_counter }};

                    var onloadCallback{{ ps_widget_counter }} = function () {
                        recaptcha_widget{{ ps_widget_counter }} = grecaptcha.render('g-recaptcha-{{ ps_widget_counter }}', {
                            'sitekey': '{{ ps_site_key }}',
                            'theme': '{{ ps_badge_theme }}',
                            'size': '{{ ps_badge_size }}'
                        });
                    };

                    var form = document.currentScript ? document.currentScript.closest('form') : null;

                    if (typeof form !== 'undefined') {
                        var resetRecaptcha{{ ps_widget_counter }} = function () {
                            if (window.grecaptcha && typeof grecaptcha.reset === 'function') {
                                grecaptcha.reset(recaptcha_widget{{ ps_widget_counter }});
                            } else {
                                console.warn('Google reCAPTCHA is not initialized.');
                            }
                        };

                        form.addEventListener('submit', function () {
                            setTimeout(resetRecaptcha{{ ps_widget_counter }}, 1000);
                        });
                    }
                </script>
                <script src="https://www.google.com/recaptcha/api.js?onload=onloadCallback{{ ps_widget_counter }}&render=explicit&badge={{ ps_badge_position }}" async defer></script>
                {% if ps_error_captcha %}<div class="text-danger">{{ ps_error_captcha }}</div>{% endif %}
            </div>
            {% endif %}
            ]]></add>
        </operation>
    </file>
    <file path="catalog/view/theme/default/template/account/login.twig">
        <operation>
            <search position="replace"><![CDATA[<input type="submit" value="{{ button_login }}" class="btn btn-primary" />]]></search>
            <add><![CDATA[
            {% if ps_key_type == 'v3' or ps_key_type == 'v2_invisible' %}
                <script src="https://www.google.com/recaptcha/api.js?render={{ ps_site_key }}{% if ps_badge_position != 'inline' %}&badge={{ ps_badge_position }}{% endif %}" async defer></script>
                <script>
                    var form = document.currentScript ? document.currentScript.closest('form') : null;

                    function onFormSubmit{{ ps_widget_counter }}(token) {
                        if (form) {
                            var submitEvent = new Event('submit', { bubbles: true, cancelable: true });

                            if (form.dispatchEvent(submitEvent)) {
                                form.submit();
                            }
                        } else {
                            console.error("No form element found for the current script.");
                        }
                    }
                </script>
                <input type="submit" value="{{ button_login }}" class="btn btn-primary g-recaptcha" data-sitekey="{{ ps_site_key }}" data-theme="{{ ps_badge_theme }}" data-callback="onFormSubmit{{ ps_widget_counter }}" data-badge="{{ ps_badge_position }}"{% if ps_key_type == 'v2_invisible' %} data-size="{{ ps_badge_size }}"{% endif %} data-action="submit" />
            {% else %}
                <input type="submit" value="{{ button_login }}" class="btn btn-primary" />
            {% endif %}
            ]]></add>
        </operation>
    </file>
    <!-- login end -->
</modification>
